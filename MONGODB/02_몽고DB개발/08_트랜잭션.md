# 08. 트랜잭션

트랜잭션은 데이터베이스의 논리적 처리 그룹이며 각 그룹과 트랜잭션은 여러 도큐먼트에 대한 읽기, 쓰기와 같은 작업을 하나 이상 포함할 수 있다.

* 트랜잭션은 무엇인가
* 트랜잭션을 사용하는 방법
* 애플리케이션을 위한 트랜잭션 제한 조정



## 8.1 트랜잭션 소개

트랜잭션은 읽기나 쓰기 작업이 가능한 데이터베이스 작업을 하나 이상 포함하는 데이터베이스의 논리적 처리 단위다. 트랜잭션의 중요한 특징은 작업이 성공하든 실패하든 부분적으로는 완료되지 않는다는 점이다.

> 트랜잭션을 사용하려면 몽고DB 버전이 4.2 이상이어야 한다.



### 8.1.1 ACID 정의

Atomicity는 원자성이라고 하며 트랜잭션 내 모든 작업이 적용되거나 아무 작업도 적용되지 않도록 한다. 트랜잭션은 부분적으로 적용될 수 없다.

Consistency는 일관성이라고 하며 트랜잭션이 성공하면 데이터베이스가 하나의 일관성 있는 상태에서 다음 일관성 있는 상태로 이동하도록 한다.

Isolation은 고립성이라고 하며 여러 트랜잭션이 데이터베이스에서 동시에 실행되도록 허용하는 속성이다. 트랙잭션이 다른 트랜잭션의 부분 결과를 보지 않도록 보장한다. 즉 여러 병렬 트랜잭션이 각 트랜잭션을 순차적으로 실행할 때와 동일한 결과를 얻게 된다.

Durability는 영속성이라고 하며 트랜잭션이 커밋될 때 시스템 오류가 발생하더라도 모든 데이터가 유지되도록 한다.



몽고DB는 복제 셋과 샤드 전체에 ACID 호환 트랜잭션이 있는 분산 데이터베이스다.



## 8.2 트랜잭션 사용법

몽고DB는 트랜잭션을 사용하기 위한 두 가지 API를 제공한다.

* 코어 API : 관계형 데이터베이스와 유사한 구문
* 콜백 API : 트랜잭션 사용에 권장되는 접근 방식

코어 API는 대부분의 오류에 재시도 로직을 제공하지 않으며 개발자가 작업에 대한 로직, 트랜잭션 커밋 함수, 필요한 재시도 및 오류 로직을 모두 작성해야 한다.

콜백 API는 지정된 논리 세션과 관련된 트랜잭션 시작, 콜백 함수로 제공한 함수 실행, 트랜잭션 커밋을 포함해 코어 API에 비해 많은 기능을 래핑하는 단일 함수를 제공한다. 이 함수는 커밋 오류를 처리하는 재시도 로직도 포함한다.

특히 애플리케이션이 복잡하고 추가 코드 작성이 필요할 때 코어 API보다 콜백 API를 권장한다.

> 코드 예제는 생략한다.



## 8.3 애플리케이션을 위한 트랜잭션 제한 조정

트랜잭션을 사용할 때 알아야 할 몇 가지 매개변수가 있다.

### 8.3.1 타이밍과 Oplog 크기 제한

몽고DB 트랜잭션에서 두 가지 주요 제한 범주가 있다. 

* 첫 번째는 트랜잭션의 시간 제한, 즉 특정 트랜잭션이 실행될 수 있는 시간, 트랜잭션이 락을 획득하려고 대기하는 시간, 모든 트랜잭션이 실행될 최대 길이를 제어하는 것과 관련 있다. 
* 두 번째 범주는 특히 몽고DB oplog 항목과 개별 항목에 대한 크기 제한과 관련 있다.



#### 시간 제한

트랜잭션의 최대 실행 시간은 기본적으로 1분 이하다.이는 mongod 인스턴스 레벨에서 transactionLifetimeLimitSeconds에 의해 제어되는 제한을 수정해 증가시킬 수 있다. 샤드 클라스터의 경우 모든 샤드 복제 셋 멤버에 매개변수를 설정해야 한다. 이 시간이 경과하면 트랜잭션이 만료됐다고 간주하며 주기적으로 실행되는 정리 프로세스에 의해 중단된다. 정리 프로세스는 60초와 transactionLifetimeLimitSeconds / 2 중 더 낮은 값을 주기로 실행된다.

트랜잭션에 시간 제한을 명시적으로 설정하려면 commitTransaction에 maxTimeMS를 지정하는 것이 좋다. maxTimeMS를 설정하지 않으면 transactionLifetimeLimitSeconds가 사용된다. maxTimeMS를 설정했지만 transactionLifetimeLimitSeconds를 초과하는 경우 transactionLifetimeLimitSeconds가 대신 사용된다.

> transactionLifetimeLimitSeconds은 범용적으로 설정하는 것이고 maxTimeMS은 각 트랜잭션에 명시적으로 설정해주는 차이가 있다.



트랜잭션의 작업에 필요한 락을 획득하기 위해 트랜잭션이 대기하는 최대 시간은 기본적으로 5밀리세컨드다. 이 값은 maxTransactionLockRequestTimeoutMillis에 의해 제어되는 제한을 수정해 늘릴 수 있다. 이 시간 내에 락을 회득할 수 없으면 트랜잭션은 중단된다. maxTransactionLockRequestTimeoutMillis은 크게 3가지 값을 가질 수 있다.

* 0 : 필요한 모든 락을 즉시 획득할 수 없으면 트랜잭션이 중단된다.
* -1 : 작업별 제한 시간이 maxTimeMS에 지정된 대로 사용된다.
* 0보다 큰 숫자 : 트랜잭션이 필요한 락을 획득하려고 시도하는 기간으로 해당 시간까지의 대기 시간을 구성한다.



#### Oplog 크기 제한

몽고DB는 트랜잭션의 쓰기 작업에 필요한 만큼 oplog 항목을 생성한다. 그러나 각 oplog항목은 BJSON  도큐먼트 크기 제한인 16메가바이트 이하여야 한다.



트랜잭션은 일관성을 보장하기 위해 몽고DB에서 유용한 기능을 제공하지만 풍부한 도큐먼트 모델과 함께 사용돼야 한다. 유연성 있는 모델과 스키마 설계 패턴과 같은 모범 사례를 사용하면 대부분의 상황에서 트랜잭션을 사용하지 않아도 된다. 따라서 트랜잭션은 애플리케이션에서 드물게 사용하는 것이 좋은 강력한 기능이다.



